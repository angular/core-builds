/**
 * @license
 * Copyright Google LLC All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
import { ActionResolver } from './action_resolver';
import { Dispatcher } from './dispatcher';
import { Restriction } from './restriction';
/** An internal symbol used to indicate whether propagation should be stopped or not. */
export const PROPAGATION_STOPPED_SYMBOL = Symbol.for('propagationStopped');
/** Extra event phases beyond what the browser provides. */
export const EventPhase = {
    REPLAY: 101,
};
const PREVENT_DEFAULT_ERROR_MESSAGE_DETAILS = ' Because event replay occurs after browser dispatch, `preventDefault` would have no ' +
    'effect. You can check whether an event is being replayed by accessing the event phase: ' +
    '`event.eventPhase === EventPhase.REPLAY`.';
const PREVENT_DEFAULT_ERROR_MESSAGE = `\`preventDefault\` called during event replay.`;
const COMPOSED_PATH_ERROR_MESSAGE_DETAILS = ' Because event replay occurs after browser ' +
    'dispatch, `composedPath()` will be empty. Iterate parent nodes from `event.target` or ' +
    '`event.currentTarget` if you need to check elements in the event path.';
const COMPOSED_PATH_ERROR_MESSAGE = `\`composedPath\` called during event replay.`;
/**
 * A dispatcher that uses browser-based `Event` semantics, for example bubbling, `stopPropagation`,
 * `currentTarget`, etc.
 */
export class EventDispatcher {
    constructor(dispatchDelegate, clickModSupport = true) {
        this.dispatchDelegate = dispatchDelegate;
        this.clickModSupport = clickModSupport;
        this.actionResolver = new ActionResolver({ clickModSupport });
        this.dispatcher = new Dispatcher((eventInfoWrapper) => {
            this.dispatchToDelegate(eventInfoWrapper);
        }, {
            actionResolver: this.actionResolver,
        });
    }
    /**
     * The entrypoint for the `EventContract` dispatch.
     */
    dispatch(eventInfo) {
        this.dispatcher.dispatch(eventInfo);
    }
    /** Internal method that does basic disaptching. */
    dispatchToDelegate(eventInfoWrapper) {
        if (eventInfoWrapper.getIsReplay()) {
            prepareEventForReplay(eventInfoWrapper);
        }
        prepareEventForBubbling(eventInfoWrapper);
        while (eventInfoWrapper.getAction()) {
            prepareEventForDispatch(eventInfoWrapper);
            this.dispatchDelegate(eventInfoWrapper.getEvent(), eventInfoWrapper.getAction().name);
            if (propagationStopped(eventInfoWrapper)) {
                return;
            }
            this.actionResolver.resolveParentAction(eventInfoWrapper.eventInfo);
        }
    }
}
function prepareEventForBubbling(eventInfoWrapper) {
    const event = eventInfoWrapper.getEvent();
    const stopPropagation = () => {
        event[PROPAGATION_STOPPED_SYMBOL] = true;
    };
    patchEventInstance(event, 'stopPropagation', stopPropagation);
    patchEventInstance(event, 'stopImmediatePropagation', stopPropagation);
}
function propagationStopped(eventInfoWrapper) {
    const event = eventInfoWrapper.getEvent();
    return !!event[PROPAGATION_STOPPED_SYMBOL];
}
function prepareEventForReplay(eventInfoWrapper) {
    const event = eventInfoWrapper.getEvent();
    const target = eventInfoWrapper.getTargetElement();
    patchEventInstance(event, 'target', target);
    patchEventInstance(event, 'eventPhase', EventPhase.REPLAY);
    patchEventInstance(event, 'preventDefault', () => {
        throw new Error(PREVENT_DEFAULT_ERROR_MESSAGE + (ngDevMode ? PREVENT_DEFAULT_ERROR_MESSAGE_DETAILS : ''));
    });
    patchEventInstance(event, 'composedPath', () => {
        throw new Error(COMPOSED_PATH_ERROR_MESSAGE + (ngDevMode ? COMPOSED_PATH_ERROR_MESSAGE_DETAILS : ''));
    });
}
function prepareEventForDispatch(eventInfoWrapper) {
    const event = eventInfoWrapper.getEvent();
    const currentTarget = eventInfoWrapper.getAction()?.element;
    if (currentTarget) {
        patchEventInstance(event, 'currentTarget', currentTarget, {
            // `currentTarget` is going to get reassigned every dispatch.
            configurable: true,
        });
    }
}
/**
 * Patch `Event` instance during non-standard `Event` dispatch. This patches just the `Event`
 * instance that the browser created, it does not patch global properties or methods.
 *
 * This is necessary because dispatching an `Event` outside of browser dispatch results in
 * incorrect properties and methods that need to be polyfilled or do not work.
 *
 * JSAction dispatch adds two extra "phases" to event dispatch:
 * 1. Event delegation - the event is being dispatched by a delegating event handler on a container
 *    (typically `window.document.documentElement`), to a delegated event handler on some child
 *    element. Certain `Event` properties will be unintuitive, such as `currentTarget`, which would
 *    be the container rather than the child element. Bubbling would also not work. In order to
 *    emulate the browser, these properties and methods on the `Event` are patched.
 * 2. Event replay - the event is being dispatched by the framework once the handlers have been
 *    loaded (during hydration, or late-loaded). Certain `Event` properties can be unset by the
 *    browser because the `Event` is no longer actively being dispatched, such as `target`. Other
 *    methods have no effect because the `Event` has already been dispatched, such as
 *    `preventDefault`. Bubbling would also not work. These properties and methods are patched,
 *    either to fill in information that the browser may have removed, or to throw errors in methods
 *    that no longer behave as expected.
 */
function patchEventInstance(event, property, value, { configurable = false } = {}) {
    Object.defineProperty(event, property, { value, configurable });
}
/**
 * Registers deferred functionality for an EventContract and a Jsaction
 * Dispatcher.
 */
export function registerDispatcher(eventContract, dispatcher) {
    eventContract.ecrd((eventInfo) => {
        dispatcher.dispatch(eventInfo);
    }, Restriction.I_AM_THE_JSACTION_FRAMEWORK);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnRfZGlzcGF0Y2hlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2NvcmUvcHJpbWl0aXZlcy9ldmVudC1kaXNwYXRjaC9zcmMvZXZlbnRfZGlzcGF0Y2hlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0dBTUc7QUFFSCxPQUFPLEVBQUMsY0FBYyxFQUFDLE1BQU0sbUJBQW1CLENBQUM7QUFDakQsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLGNBQWMsQ0FBQztBQUd4QyxPQUFPLEVBQUMsV0FBVyxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBTzFDLHdGQUF3RjtBQUN4RixNQUFNLENBQUMsTUFBTSwwQkFBMEIsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLG9CQUFvQixDQUFDLENBQUM7QUFFM0UsMkRBQTJEO0FBQzNELE1BQU0sQ0FBQyxNQUFNLFVBQVUsR0FBRztJQUN4QixNQUFNLEVBQUUsR0FBRztDQUNaLENBQUM7QUFFRixNQUFNLHFDQUFxQyxHQUN6QyxzRkFBc0Y7SUFDdEYseUZBQXlGO0lBQ3pGLDJDQUEyQyxDQUFDO0FBQzlDLE1BQU0sNkJBQTZCLEdBQUcsZ0RBQWdELENBQUM7QUFDdkYsTUFBTSxtQ0FBbUMsR0FDdkMsNkNBQTZDO0lBQzdDLHdGQUF3RjtJQUN4Rix3RUFBd0UsQ0FBQztBQUMzRSxNQUFNLDJCQUEyQixHQUFHLDhDQUE4QyxDQUFDO0FBUW5GOzs7R0FHRztBQUNILE1BQU0sT0FBTyxlQUFlO0lBSzFCLFlBQ21CLGdCQUE0RCxFQUM1RCxrQkFBa0IsSUFBSTtRQUR0QixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQTRDO1FBQzVELG9CQUFlLEdBQWYsZUFBZSxDQUFPO1FBRXZDLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxjQUFjLENBQUMsRUFBQyxlQUFlLEVBQUMsQ0FBQyxDQUFDO1FBQzVELElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxV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S0FBSyxHQUFHLGdCQUFnQixDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQzFDLE1BQU0sYUFBYSxHQUFHLGdCQUFnQixDQUFDLFNBQVMsRUFBRSxFQUFFLE9BQU8sQ0FBQztJQUM1RCxJQUFJLGFBQWEsRUFBRSxDQUFDO1FBQ2xCLGtCQUFrQixDQUFDLEtBQUssRUFBRSxlQUFlLEVBQUUsYUFBYSxFQUFFO1lBQ3hELDZEQUE2RDtZQUM3RCxZQUFZLEVBQUUsSUFBSTtTQUNuQixDQUFDLENBQUM7SUFDTCxDQUFDO0FBQ0gsQ0FBQztBQUVEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQW9CRztBQUNILFNBQVMsa0JBQWtCLENBQ3pCLEtBQVksRUFDWixRQUFnQixFQUNoQixLQUFRLEVBQ1IsRUFBQyxZQUFZLEdBQUcsS0FBSyxLQUE4QixFQUFFO0lBRXJELE1BQU0sQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxFQUFDLEtBQUssRUFBRSxZQUFZLEVBQUMsQ0FBQyxDQUFDO0FBQ2hFLENBQUM7QUFFRDs7O0dBR0c7QUFDSCxNQUFNLFVBQVUsa0JBQWtCLENBQ2hDLGFBQXFDLEVBQ3JDLFVBQTJCO0lBRTNCLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxTQUFvQixFQUFFLEVBQUU7UUFDMUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUNqQyxDQUFDLEVBQUUsV0FBVyxDQUFDLDJCQUEyQixDQUFDLENBQUM7QUFDOUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBHb29nbGUgTExDIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuXG5pbXBvcnQge0FjdGlvblJlc29sdmVyfSBmcm9tICcuL2FjdGlvbl9yZXNvbHZlcic7XG5pbXBvcnQge0Rpc3BhdGNoZXJ9IGZyb20gJy4vZGlzcGF0Y2hlcic7XG5pbXBvcnQge0V2ZW50SW5mbywgRXZlbnRJbmZvV3JhcHBlcn0gZnJvbSAnLi9ldmVudF9pbmZvJztcbmltcG9ydCB7VW5yZW5hbWVkRXZlbnRDb250cmFjdH0gZnJvbSAnLi9ldmVudGNvbnRyYWN0JztcbmltcG9ydCB7UmVzdHJpY3Rpb259IGZyb20gJy4vcmVzdHJpY3Rpb24nO1xuXG4vKipcbiAqIEEgcmVwbGF5ZXIgaXMgYSBmdW5jdGlvbiB0aGF0IGlzIGNhbGxlZCB3aGVuIHRoZXJlIGFyZSBxdWV1ZWQgZXZlbnRzLCBmcm9tIHRoZSBgRXZlbnRDb250cmFjdGAuXG4gKi9cbmV4cG9ydCB0eXBlIFJlcGxheWVyID0gKGV2ZW50SW5mb1dyYXBwZXJzOiBFdmVudFtdKSA9PiB2b2lkO1xuXG4vKiogQW4gaW50ZXJuYWwgc3ltYm9sIHVzZWQgdG8gaW5kaWNhdGUgd2hldGhlciBwcm9wYWdhdGlvbiBzaG91bGQgYmUgc3RvcHBlZCBvciBub3QuICovXG5leHBvcnQgY29uc3QgUFJPUEFHQVRJT05fU1RPUFBFRF9TWU1CT0wgPSBTeW1ib2wuZm9yKCdwcm9wYWdhdGlvblN0b3BwZWQnKTtcblxuLyoqIEV4dHJhIGV2ZW50IHBoYXNlcyBiZXlvbmQgd2hhdCB0aGUgYnJvd3NlciBwcm92aWRlcy4gKi9cbmV4cG9ydCBjb25zdCBFdmVudFBoYXNlID0ge1xuICBSRVBMQVk6IDEwMSxcbn07XG5cbmNvbnN0IFBSRVZFTlRfREVGQVVMVF9FUlJPUl9NRVNTQUdFX0RFVEFJTFMgPVxuICAnIEJlY2F1c2UgZXZlbnQgcmVwbGF5IG9jY3VycyBhZnRlciBicm93c2VyIGRpc3BhdGNoLCBgcHJldmVudERlZmF1bHRgIHdvdWxkIGhhdmUgbm8gJyArXG4gICdlZmZlY3QuIFlvdSBjYW4gY2hlY2sgd2hldGhlciBhbiBldmVudCBpcyBiZWluZyByZXBsYXllZCBieSBhY2Nlc3NpbmcgdGhlIGV2ZW50IHBoYXNlOiAnICtcbiAgJ2BldmVudC5ldmVudFBoYXNlID09PSBFdmVudFBoYXNlLlJFUExBWWAuJztcbmNvbnN0IFBSRVZFTlRfREVGQVVMVF9FUlJPUl9NRVNTQUdFID0gYFxcYHByZXZlbnREZWZhdWx0XFxgIGNhbGxlZCBkdXJpbmcgZXZlbnQgcmVwbGF5LmA7XG5jb25zdCBDT01QT1NFRF9QQVRIX0VSUk9SX01FU1NBR0VfREVUQUlMUyA9XG4gICcgQmVjYXVzZSBldmVudCByZXBsYXkgb2NjdXJzIGFmdGVyIGJyb3dzZXIgJyArXG4gICdkaXNwYXRjaCwgYGNvbXBvc2VkUGF0aCgpYCB3aWxsIGJlIGVtcHR5LiBJdGVyYXRlIHBhcmVudCBub2RlcyBmcm9tIGBldmVudC50YXJnZXRgIG9yICcgK1xuICAnYGV2ZW50LmN1cnJlbnRUYXJnZXRgIGlmIHlvdSBuZWVkIHRvIGNoZWNrIGVsZW1lbnRzIGluIHRoZSBldmVudCBwYXRoLic7XG5jb25zdCBDT01QT1NFRF9QQVRIX0VSUk9SX01FU1NBR0UgPSBgXFxgY29tcG9zZWRQYXRoXFxgIGNhbGxlZCBkdXJpbmcgZXZlbnQgcmVwbGF5LmA7XG5cbmRlY2xhcmUgZ2xvYmFsIHtcbiAgaW50ZXJmYWNlIEV2ZW50IHtcbiAgICBbUFJPUEFHQVRJT05fU1RPUFBFRF9TWU1CT0xdPzogYm9vbGVhbjtcbiAgfVxufVxuXG4vKipcbiAqIEEgZGlzcGF0Y2hlciB0aGF0IHVzZXMgYnJvd3Nlci1iYXNlZCBgRXZlbnRgIHNlbWFudGljcywgZm9yIGV4YW1wbGUgYnViYmxpbmcsIGBzdG9wUHJvcGFnYXRpb25gLFxuICogYGN1cnJlbnRUYXJnZXRgLCBldGMuXG4gKi9cbmV4cG9ydCBjbGFzcyBFdmVudERpc3BhdGNoZXIge1xuICBwcml2YXRlIHJlYWRvbmx5IGFjdGlvblJlc29sdmVyOiBBY3Rpb25SZXNvbHZlcjtcblxuICBwcml2YXRlIHJlYWRvbmx5IGRpc3BhdGNoZXI6IERpc3BhdGNoZXI7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBkaXNwYXRjaERlbGVnYXRlOiAoZXZlbnQ6IEV2ZW50LCBhY3Rpb25OYW1lOiBzdHJpbmcpID0+IHZvaWQsXG4gICAgcHJpdmF0ZSByZWFkb25seSBjbGlja01vZFN1cHBvcnQgPSB0cnVlLFxuICApIHtcbiAgICB0aGlzLmFjdGlvblJlc29sdmVyID0gbmV3IEFjdGlvblJlc29sdmVyKHtjbGlja01vZFN1cHBvcnR9KTtcbiAgICB0aGlzLmRpc3BhdGNoZXIgPSBuZXcgRGlzcGF0Y2hlcihcbiAgICAgIChldmVudEluZm9XcmFwcGVyOiBFdmVudEluZm9XcmFwcGVyKSA9PiB7XG4gICAgICAgIHRoaXMuZGlzcGF0Y2hUb0RlbGVnYXRlKGV2ZW50SW5mb1dyYXBwZXIpO1xuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgYWN0aW9uUmVzb2x2ZXI6IHRoaXMuYWN0aW9uUmVzb2x2ZXIsXG4gICAgICB9LFxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogVGhlIGVudHJ5cG9pbnQgZm9yIHRoZSBgRXZlbnRDb250cmFjdGAgZGlzcGF0Y2guXG4gICAqL1xuICBkaXNwYXRjaChldmVudEluZm86IEV2ZW50SW5mbyk6IHZvaWQge1xuICAgIHRoaXMuZGlzcGF0Y2hlci5kaXNwYXRjaChldmVudEluZm8pO1xuICB9XG5cbiAgLyoqIEludGVybmFsIG1ldGhvZCB0aGF0IGRvZXMgYmFzaWMgZGlzYXB0Y2hpbmcuICovXG4gIHByaXZhdGUgZGlzcGF0Y2hUb0RlbGVnYXRlKGV2ZW50SW5mb1dyYXBwZXI6IEV2ZW50SW5mb1dyYXBwZXIpIHtcbiAgICBpZiAoZXZlbnRJbmZvV3JhcHBlci5nZXRJc1JlcGxheSgpKSB7XG4gICAgICBwcmVwYXJlRXZlbnRGb3JSZXBsYXkoZXZlbnRJbmZvV3JhcHBlcik7XG4gICAgfVxuICAgIHByZXBhcmVFdmVudEZvckJ1YmJsaW5nKGV2ZW50SW5mb1dyYXBwZXIpO1xuICAgIHdoaWxlIChldmVudEluZm9XcmFwcGVyLmdldEFjdGlvbigpKSB7XG4gICAgICBwcmVwYXJlRXZlbnRGb3JEaXNwYXRjaChldmVudEluZm9XcmFwcGVyKTtcbiAgICAgIHRoaXMuZGlzcGF0Y2hEZWxlZ2F0ZShldmVudEluZm9XcmFwcGVyLmdldEV2ZW50KCksIGV2ZW50SW5mb1dyYXBwZXIuZ2V0QWN0aW9uKCkhLm5hbWUpO1xuICAgICAgaWYgKHByb3BhZ2F0aW9uU3RvcHBlZChldmVudEluZm9XcmFwcGVyKSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICB0aGlzLmFjdGlvblJlc29sdmVyLnJlc29sdmVQYXJlbnRBY3Rpb24oZXZlbnRJbmZvV3JhcHBlci5ldmVudEluZm8pO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBwcmVwYXJlRXZlbnRGb3JCdWJibGluZyhldmVudEluZm9XcmFwcGVyOiBFdmVudEluZm9XcmFwcGVyKSB7XG4gIGNvbnN0IGV2ZW50ID0gZXZlbnRJbmZvV3JhcHBlci5nZXRFdmVudCgpO1xuICBjb25zdCBzdG9wUHJvcGFnYXRpb24gPSAoKSA9PiB7XG4gICAgZXZlbnRbUFJPUEFHQVRJT05fU1RPUFBFRF9TWU1CT0xdID0gdHJ1ZTtcbiAgfTtcbiAgcGF0Y2hFdmVudEluc3RhbmNlKGV2ZW50LCAnc3RvcFByb3BhZ2F0aW9uJywgc3RvcFByb3BhZ2F0aW9uKTtcbiAgcGF0Y2hFdmVudEluc3RhbmNlKGV2ZW50LCAnc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uJywgc3RvcFByb3BhZ2F0aW9uKTtcbn1cblxuZnVuY3Rpb24gcHJvcGFnYXRpb25TdG9wcGVkKGV2ZW50SW5mb1dyYXBwZXI6IEV2ZW50SW5mb1dyYXBwZXIpIHtcbiAgY29uc3QgZXZlbnQgPSBldmVudEluZm9XcmFwcGVyLmdldEV2ZW50KCk7XG4gIHJldHVybiAhIWV2ZW50W1BST1BBR0FUSU9OX1NUT1BQRURfU1lNQk9MXTtcbn1cblxuZnVuY3Rpb24gcHJlcGFyZUV2ZW50Rm9yUmVwbGF5KGV2ZW50SW5mb1dyYXBwZXI6IEV2ZW50SW5mb1dyYXBwZXIpIHtcbiAgY29uc3QgZXZlbnQgPSBldmVudEluZm9XcmFwcGVyLmdldEV2ZW50KCk7XG4gIGNvbnN0IHRhcmdldCA9IGV2ZW50SW5mb1dyYXBwZXIuZ2V0VGFyZ2V0RWxlbWVudCgpO1xuICBwYXRjaEV2ZW50SW5zdGFuY2UoZXZlbnQsICd0YXJnZXQnLCB0YXJnZXQpO1xuICBwYXRjaEV2ZW50SW5zdGFuY2UoZXZlbnQsICdldmVudFBoYXNlJywgRXZlbnRQaGFzZS5SRVBMQVkpO1xuICBwYXRjaEV2ZW50SW5zdGFuY2UoZXZlbnQsICdwcmV2ZW50RGVmYXVsdCcsICgpID0+IHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBQUkVWRU5UX0RFRkFVTFRfRVJST1JfTUVTU0FHRSArIChuZ0Rldk1vZGUgPyBQUkVWRU5UX0RFRkFVTFRfRVJST1JfTUVTU0FHRV9ERVRBSUxTIDogJycpLFxuICAgICk7XG4gIH0pO1xuICBwYXRjaEV2ZW50SW5zdGFuY2UoZXZlbnQsICdjb21wb3NlZFBhdGgnLCAoKSA9PiB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgQ09NUE9TRURfUEFUSF9FUlJPUl9NRVNTQUdFICsgKG5nRGV2TW9kZSA/IENPTVBPU0VEX1BBVEhfRVJST1JfTUVTU0FHRV9ERVRBSUxTIDogJycpLFxuICAgICk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBwcmVwYXJlRXZlbnRGb3JEaXNwYXRjaChldmVudEluZm9XcmFwcGVyOiBFdmVudEluZm9XcmFwcGVyKSB7XG4gIGNvbnN0IGV2ZW50ID0gZXZlbnRJbmZvV3JhcHBlci5nZXRFdmVudCgpO1xuICBjb25zdCBjdXJyZW50VGFyZ2V0ID0gZXZlbnRJbmZvV3JhcHBlci5nZXRBY3Rpb24oKT8uZWxlbWVudDtcbiAgaWYgKGN1cnJlbnRUYXJnZXQpIHtcbiAgICBwYXRjaEV2ZW50SW5zdGFuY2UoZXZlbnQsICdjdXJyZW50VGFyZ2V0JywgY3VycmVudFRhcmdldCwge1xuICAgICAgLy8gYGN1cnJlbnRUYXJnZXRgIGlzIGdvaW5nIHRvIGdldCByZWFzc2lnbmVkIGV2ZXJ5IGRpc3BhdGNoLlxuICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgIH0pO1xuICB9XG59XG5cbi8qKlxuICogUGF0Y2ggYEV2ZW50YCBpbnN0YW5jZSBkdXJpbmcgbm9uLXN0YW5kYXJkIGBFdmVudGAgZGlzcGF0Y2guIFRoaXMgcGF0Y2hlcyBqdXN0IHRoZSBgRXZlbnRgXG4gKiBpbnN0YW5jZSB0aGF0IHRoZSBicm93c2VyIGNyZWF0ZWQsIGl0IGRvZXMgbm90IHBhdGNoIGdsb2JhbCBwcm9wZXJ0aWVzIG9yIG1ldGhvZHMuXG4gKlxuICogVGhpcyBpcyBuZWNlc3NhcnkgYmVjYXVzZSBkaXNwYXRjaGluZyBhbiBgRXZlbnRgIG91dHNpZGUgb2YgYnJvd3NlciBkaXNwYXRjaCByZXN1bHRzIGluXG4gKiBpbmNvcnJlY3QgcHJvcGVydGllcyBhbmQgbWV0aG9kcyB0aGF0IG5lZWQgdG8gYmUgcG9seWZpbGxlZCBvciBkbyBub3Qgd29yay5cbiAqXG4gKiBKU0FjdGlvbiBkaXNwYXRjaCBhZGRzIHR3byBleHRyYSBcInBoYXNlc1wiIHRvIGV2ZW50IGRpc3BhdGNoOlxuICogMS4gRXZlbnQgZGVsZWdhdGlvbiAtIHRoZSBldmVudCBpcyBiZWluZyBkaXNwYXRjaGVkIGJ5IGEgZGVsZWdhdGluZyBldmVudCBoYW5kbGVyIG9uIGEgY29udGFpbmVyXG4gKiAgICAodHlwaWNhbGx5IGB3aW5kb3cuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50YCksIHRvIGEgZGVsZWdhdGVkIGV2ZW50IGhhbmRsZXIgb24gc29tZSBjaGlsZFxuICogICAgZWxlbWVudC4gQ2VydGFpbiBgRXZlbnRgIHByb3BlcnRpZXMgd2lsbCBiZSB1bmludHVpdGl2ZSwgc3VjaCBhcyBgY3VycmVudFRhcmdldGAsIHdoaWNoIHdvdWxkXG4gKiAgICBiZSB0aGUgY29udGFpbmVyIHJhdGhlciB0aGFuIHRoZSBjaGlsZCBlbGVtZW50LiBCdWJibGluZyB3b3VsZCBhbHNvIG5vdCB3b3JrLiBJbiBvcmRlciB0b1xuICogICAgZW11bGF0ZSB0aGUgYnJvd3NlciwgdGhlc2UgcHJvcGVydGllcyBhbmQgbWV0aG9kcyBvbiB0aGUgYEV2ZW50YCBhcmUgcGF0Y2hlZC5cbiAqIDIuIEV2ZW50IHJlcGxheSAtIHRoZSBldmVudCBpcyBiZWluZyBkaXNwYXRjaGVkIGJ5IHRoZSBmcmFtZXdvcmsgb25jZSB0aGUgaGFuZGxlcnMgaGF2ZSBiZWVuXG4gKiAgICBsb2FkZWQgKGR1cmluZyBoeWRyYXRpb24sIG9yIGxhdGUtbG9hZGVkKS4gQ2VydGFpbiBgRXZlbnRgIHByb3BlcnRpZXMgY2FuIGJlIHVuc2V0IGJ5IHRoZVxuICogICAgYnJvd3NlciBiZWNhdXNlIHRoZSBgRXZlbnRgIGlzIG5vIGxvbmdlciBhY3RpdmVseSBiZWluZyBkaXNwYXRjaGVkLCBzdWNoIGFzIGB0YXJnZXRgLiBPdGhlclxuICogICAgbWV0aG9kcyBoYXZlIG5vIGVmZmVjdCBiZWNhdXNlIHRoZSBgRXZlbnRgIGhhcyBhbHJlYWR5IGJlZW4gZGlzcGF0Y2hlZCwgc3VjaCBhc1xuICogICAgYHByZXZlbnREZWZhdWx0YC4gQnViYmxpbmcgd291bGQgYWxzbyBub3Qgd29yay4gVGhlc2UgcHJvcGVydGllcyBhbmQgbWV0aG9kcyBhcmUgcGF0Y2hlZCxcbiAqICAgIGVpdGhlciB0byBmaWxsIGluIGluZm9ybWF0aW9uIHRoYXQgdGhlIGJyb3dzZXIgbWF5IGhhdmUgcmVtb3ZlZCwgb3IgdG8gdGhyb3cgZXJyb3JzIGluIG1ldGhvZHNcbiAqICAgIHRoYXQgbm8gbG9uZ2VyIGJlaGF2ZSBhcyBleHBlY3RlZC5cbiAqL1xuZnVuY3Rpb24gcGF0Y2hFdmVudEluc3RhbmNlPFQ+KFxuICBldmVudDogRXZlbnQsXG4gIHByb3BlcnR5OiBzdHJpbmcsXG4gIHZhbHVlOiBULFxuICB7Y29uZmlndXJhYmxlID0gZmFsc2V9OiB7Y29uZmlndXJhYmxlPzogYm9vbGVhbn0gPSB7fSxcbikge1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXZlbnQsIHByb3BlcnR5LCB7dmFsdWUsIGNvbmZpZ3VyYWJsZX0pO1xufVxuXG4vKipcbiAqIFJlZ2lzdGVycyBkZWZlcnJlZCBmdW5jdGlvbmFsaXR5IGZvciBhbiBFdmVudENvbnRyYWN0IGFuZCBhIEpzYWN0aW9uXG4gKiBEaXNwYXRjaGVyLlxuICovXG5leHBvcnQgZnVuY3Rpb24gcmVnaXN0ZXJEaXNwYXRjaGVyKFxuICBldmVudENvbnRyYWN0OiBVbnJlbmFtZWRFdmVudENvbnRyYWN0LFxuICBkaXNwYXRjaGVyOiBFdmVudERpc3BhdGNoZXIsXG4pIHtcbiAgZXZlbnRDb250cmFjdC5lY3JkKChldmVudEluZm86IEV2ZW50SW5mbykgPT4ge1xuICAgIGRpc3BhdGNoZXIuZGlzcGF0Y2goZXZlbnRJbmZvKTtcbiAgfSwgUmVzdHJpY3Rpb24uSV9BTV9USEVfSlNBQ1RJT05fRlJBTUVXT1JLKTtcbn1cbiJdfQ==