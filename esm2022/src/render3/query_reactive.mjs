/**
 * @license
 * Copyright Google LLC All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
import { createComputed, SIGNAL } from '@angular/core/primitives/signals';
import { RuntimeError } from '../errors';
import { unwrapElementRef } from '../linker/element_ref';
import { EMPTY_ARRAY } from '../util/empty';
import { FLAGS, TVIEW } from './interfaces/view';
import { collectQueryResults, getTQuery, loadQueryInternal, materializeViewResults } from './query';
import { signal } from './reactivity/signal';
import { getLView } from './state';
/**
 * Query-as signal factory function in charge of creating a new computed signal capturing query
 * results. This centralized creation function is used by all types of queries (child / children,
 * required / optional).
 *
 * @param firstOnly indicates if all or only the first result should be returned
 * @param required indicates if at least one result is required
 * @returns a read-only signal with query results
 */
function createQuerySignalFn(firstOnly, required) {
    let node;
    const signalFn = createComputed(() => {
        // A dedicated signal that increments its value every time a query changes its dirty status. By
        // using this signal we can implement a query as computed and avoid creation of a specialized
        // reactive node type. Please note that a query gets marked dirty under the following
        // circumstances:
        // - a view (where a query is active) finished its first creation pass;
        // - a new view is inserted / deleted and it impacts query results.
        node._dirtyCounter();
        const value = refreshSignalQuery(node, firstOnly);
        if (required && value === undefined) {
            throw new RuntimeError(-951 /* RuntimeErrorCode.REQUIRED_QUERY_NO_VALUE */, ngDevMode && 'Child query result is required but no value is available.');
        }
        return value;
    });
    node = signalFn[SIGNAL];
    node._dirtyCounter = signal(0);
    if (ngDevMode) {
        signalFn.toString = () => `[Query Signal]`;
    }
    return signalFn;
}
export function createSingleResultOptionalQuerySignalFn() {
    return createQuerySignalFn(/* firstOnly */ true, /* required */ false);
}
export function createSingleResultRequiredQuerySignalFn() {
    return createQuerySignalFn(/* firstOnly */ true, /* required */ true);
}
export function createMultiResultQuerySignalFn() {
    return createQuerySignalFn(/* firstOnly */ false, /* required */ false);
}
export function bindQueryToSignal(target, queryIndex) {
    const node = target[SIGNAL];
    node._lView = getLView();
    node._queryIndex = queryIndex;
    node._queryList = loadQueryInternal(node._lView, queryIndex);
    node._queryList.onDirty(() => node._dirtyCounter.update(v => v + 1));
}
function refreshSignalQuery(node, firstOnly) {
    const lView = node._lView;
    const queryIndex = node._queryIndex;
    // There are 2 conditions under which we want to return "empty" results instead of the ones
    // collected by a query:
    //
    // 1) a given query wasn't created yet (this is a period of time between the directive creation
    // and execution of the query creation function) - in this case a query doesn't exist yet and we
    // don't have any results to return.
    //
    // 2) we are in the process of constructing a view (the first
    // creation pass didn't finish) and a query might have partial results, but we don't want to
    // return those - instead we do delay results collection until all nodes had a chance of matching
    // and we can present consistent, "atomic" (on a view level) results.
    if (lView === undefined || queryIndex === undefined || (lView[FLAGS] & 4 /* LViewFlags.CreationMode */)) {
        return (firstOnly ? undefined : EMPTY_ARRAY);
    }
    const queryList = loadQueryInternal(lView, queryIndex);
    const tView = lView[TVIEW];
    const tQuery = getTQuery(tView, queryIndex);
    // TODO(refactor): add an utility method for the following logic
    const result = tQuery.crossesNgTemplate ?
        collectQueryResults(tView, lView, queryIndex, []) :
        materializeViewResults(tView, lView, tQuery, queryIndex);
    queryList.reset(result, unwrapElementRef);
    return firstOnly ? queryList.first : queryList.toArray();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlcnlfcmVhY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9jb3JlL3NyYy9yZW5kZXIzL3F1ZXJ5X3JlYWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7R0FNRztBQUVILE9BQU8sRUFBZSxjQUFjLEVBQUUsTUFBTSxFQUFDLE1BQU0sa0NBQWtDLENBQUM7QUFFdEYsT0FBTyxFQUFDLFlBQVksRUFBbUIsTUFBTSxXQUFXLENBQUM7QUFDekQsT0FBTyxFQUFDLGdCQUFnQixFQUFDLE1BQU0sdUJBQXVCLENBQUM7QUFFdkQsT0FBTyxFQUFDLFdBQVcsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUUxQyxPQUFPLEVBQUMsS0FBSyxFQUFxQixLQUFLLEVBQUMsTUFBTSxtQkFBbUIsQ0FBQztBQUNsRSxPQUFPLEVBQUMsbUJBQW1CLEVBQUUsU0FBUyxFQUFFLGlCQUFpQixFQUFFLHNCQUFzQixFQUFDLE1BQU0sU0FBUyxDQUFDO0FBRWxHLE9BQU8sRUFBQyxNQUFNLEVBQWlCLE1BQU0scUJBQXFCLENBQUM7QUFDM0QsT0FBTyxFQUFDLFFBQVEsRUFBQyxNQUFNLFNBQVMsQ0FBQztBQVNqQzs7Ozs7Ozs7R0FRRztBQUNILFNBQVMsbUJBQW1CLENBQUksU0FBa0IsRUFBRSxRQUFpQjtJQUNuRSxJQUFJLElBQXdCLENBQUM7SUFDN0IsTUFBTSxRQUFRLEdBQUcsY0FBYyxDQUFDLEdBQUcsRUFBRTtRQUNuQywrRkFBK0Y7UUFDL0YsNkZBQTZGO1FBQzdGLHFGQUFxRjtRQUNyRixpQkFBaUI7UUFDakIsdUVBQXVFO1FBQ3ZFLG1FQUFtRTtRQUNuRSxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFFckIsTUFBTSxLQUFLLEdBQUcsa0JBQWtCLENBQUksSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBRXJELElBQUksUUFBUSxJQUFJLEtBQUssS0FBSyxTQUFTLEVBQUUsQ0FB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RWhFLFNBQVMsQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLGdCQUFnQixDQUFDLENBQUM7SUFFMUMsT0FBTyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUMzRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBMTEMgQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5cbmltcG9ydCB7Q29tcHV0ZWROb2RlLCBjcmVhdGVDb21wdXRlZCwgU0lHTkFMfSBmcm9tICdAYW5ndWxhci9jb3JlL3ByaW1pdGl2ZXMvc2lnbmFscyc7XG5cbmltcG9ydCB7UnVudGltZUVycm9yLCBSdW50aW1lRXJyb3JDb2RlfSBmcm9tICcuLi9lcnJvcnMnO1xuaW1wb3J0IHt1bndyYXBFbGVtZW50UmVmfSBmcm9tICcuLi9saW5rZXIvZWxlbWVudF9yZWYnO1xuaW1wb3J0IHtRdWVyeUxpc3R9IGZyb20gJy4uL2xpbmtlci9xdWVyeV9saXN0JztcbmltcG9ydCB7RU1QVFlfQVJSQVl9IGZyb20gJy4uL3V0aWwvZW1wdHknO1xuXG5pbXBvcnQge0ZMQUdTLCBMVmlldywgTFZpZXdGbGFncywgVFZJRVd9IGZyb20gJy4vaW50ZXJmYWNlcy92aWV3JztcbmltcG9ydCB7Y29sbGVjdFF1ZXJ5UmVzdWx0cywgZ2V0VFF1ZXJ5LCBsb2FkUXVlcnlJbnRlcm5hbCwgbWF0ZXJpYWxpemVWaWV3UmVzdWx0c30gZnJvbSAnLi9xdWVyeSc7XG5pbXBvcnQge1NpZ25hbH0gZnJvbSAnLi9yZWFjdGl2aXR5L2FwaSc7XG5pbXBvcnQge3NpZ25hbCwgV3JpdGFibGVTaWduYWx9IGZyb20gJy4vcmVhY3Rpdml0eS9zaWduYWwnO1xuaW1wb3J0IHtnZXRMVmlld30gZnJvbSAnLi9zdGF0ZSc7XG5cbmludGVyZmFjZSBRdWVyeVNpZ25hbE5vZGU8VD4gZXh0ZW5kcyBDb21wdXRlZE5vZGU8VHxSZWFkb25seUFycmF5PFQ+PiB7XG4gIF9sVmlldz86IExWaWV3O1xuICBfcXVlcnlJbmRleD86IG51bWJlcjtcbiAgX3F1ZXJ5TGlzdD86IFF1ZXJ5TGlzdDxUPjtcbiAgX2RpcnR5Q291bnRlcjogV3JpdGFibGVTaWduYWw8bnVtYmVyPjtcbn1cblxuLyoqXG4gKiBRdWVyeS1hcyBzaWduYWwgZmFjdG9yeSBmdW5jdGlvbiBpbiBjaGFyZ2Ugb2YgY3JlYXRpbmcgYSBuZXcgY29tcHV0ZWQgc2lnbmFsIGNhcHR1cmluZyBxdWVyeVxuICogcmVzdWx0cy4gVGhpcyBjZW50cmFsaXplZCBjcmVhdGlvbiBmdW5jdGlvbiBpcyB1c2VkIGJ5IGFsbCB0eXBlcyBvZiBxdWVyaWVzIChjaGlsZCAvIGNoaWxkcmVuLFxuICogcmVxdWlyZWQgLyBvcHRpb25hbCkuXG4gKlxuICogQHBhcmFtIGZpcnN0T25seSBpbmRpY2F0ZXMgaWYgYWxsIG9yIG9ubHkgdGhlIGZpcnN0IHJlc3VsdCBzaG91bGQgYmUgcmV0dXJuZWRcbiAqIEBwYXJhbSByZXF1aXJlZCBpbmRpY2F0ZXMgaWYgYXQgbGVhc3Qgb25lIHJlc3VsdCBpcyByZXF1aXJlZFxuICogQHJldHVybnMgYSByZWFkLW9ubHkgc2lnbmFsIHdpdGggcXVlcnkgcmVzdWx0c1xuICovXG5mdW5jdGlvbiBjcmVhdGVRdWVyeVNpZ25hbEZuPFY+KGZpcnN0T25seTogYm9vbGVhbiwgcmVxdWlyZWQ6IGJvb2xlYW4pIHtcbiAgbGV0IG5vZGU6IFF1ZXJ5U2lnbmFsTm9kZTxWPjtcbiAgY29uc3Qgc2lnbmFsRm4gPSBjcmVhdGVDb21wdXRlZCgoKSA9PiB7XG4gICAgLy8gQSBkZWRpY2F0ZWQgc2lnbmFsIHRoYXQgaW5jcmVtZW50cyBpdHMgdmFsdWUgZXZlcnkgdGltZSBhIHF1ZXJ5IGNoYW5nZXMgaXRzIGRpcnR5IHN0YXR1cy4gQnlcbiAgICAvLyB1c2luZyB0aGlzIHNpZ25hbCB3ZSBjYW4gaW1wbGVtZW50IGEgcXVlcnkgYXMgY29tcHV0ZWQgYW5kIGF2b2lkIGNyZWF0aW9uIG9mIGEgc3BlY2lhbGl6ZWRcbiAgICAvLyByZWFjdGl2ZSBub2RlIHR5cGUuIFBsZWFzZSBub3RlIHRoYXQgYSBxdWVyeSBnZXRzIG1hcmtlZCBkaXJ0eSB1bmRlciB0aGUgZm9sbG93aW5nXG4gICAgLy8gY2lyY3Vtc3RhbmNlczpcbiAgICAvLyAtIGEgdmlldyAod2hlcmUgYSBxdWVyeSBpcyBhY3RpdmUpIGZpbmlzaGVkIGl0cyBmaXJzdCBjcmVhdGlvbiBwYXNzO1xuICAgIC8vIC0gYSBuZXcgdmlldyBpcyBpbnNlcnRlZCAvIGRlbGV0ZWQgYW5kIGl0IGltcGFjdHMgcXVlcnkgcmVzdWx0cy5cbiAgICBub2RlLl9kaXJ0eUNvdW50ZXIoKTtcblxuICAgIGNvbnN0IHZhbHVlID0gcmVmcmVzaFNpZ25hbFF1ZXJ5PFY+KG5vZGUsIGZpcnN0T25seSk7XG5cbiAgICBpZiAocmVxdWlyZWQgJiYgdmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcihcbiAgICAgICAgICBSdW50aW1lRXJyb3JDb2RlLlJFUVVJUkVEX1FVRVJZX05PX1ZBTFVFLFxuICAgICAgICAgIG5nRGV2TW9kZSAmJiAnQ2hpbGQgcXVlcnkgcmVzdWx0IGlzIHJlcXVpcmVkIGJ1dCBubyB2YWx1ZSBpcyBhdmFpbGFibGUuJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHZhbHVlO1xuICB9KTtcbiAgbm9kZSA9IHNpZ25hbEZuW1NJR05BTF0gYXMgUXVlcnlTaWduYWxOb2RlPFY+O1xuICBub2RlLl9kaXJ0eUNvdW50ZXIgPSBzaWduYWwoMCk7XG5cbiAgaWYgKG5nRGV2TW9kZSkge1xuICAgIHNpZ25hbEZuLnRvU3RyaW5nID0gKCkgPT4gYFtRdWVyeSBTaWduYWxdYDtcbiAgfVxuXG4gIHJldHVybiBzaWduYWxGbjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVNpbmdsZVJlc3VsdE9wdGlvbmFsUXVlcnlTaWduYWxGbjxSZWFkVD4oKTogU2lnbmFsPFJlYWRUfHVuZGVmaW5lZD4ge1xuICByZXR1cm4gY3JlYXRlUXVlcnlTaWduYWxGbigvKiBmaXJzdE9ubHkgKi8gdHJ1ZSwgLyogcmVxdWlyZWQgKi8gZmFsc2UpIGFzIFNpZ25hbDxSZWFkVHx1bmRlZmluZWQ+O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlU2luZ2xlUmVzdWx0UmVxdWlyZWRRdWVyeVNpZ25hbEZuPFJlYWRUPigpOiBTaWduYWw8UmVhZFQ+IHtcbiAgcmV0dXJuIGNyZWF0ZVF1ZXJ5U2lnbmFsRm4oLyogZmlyc3RPbmx5ICovIHRydWUsIC8qIHJlcXVpcmVkICovIHRydWUpIGFzIFNpZ25hbDxSZWFkVD47XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVNdWx0aVJlc3VsdFF1ZXJ5U2lnbmFsRm48UmVhZFQ+KCk6IFNpZ25hbDxSZWFkb25seUFycmF5PFJlYWRUPj4ge1xuICByZXR1cm4gY3JlYXRlUXVlcnlTaWduYWxGbigvKiBmaXJzdE9ubHkgKi8gZmFsc2UsIC8qIHJlcXVpcmVkICovIGZhbHNlKSBhc1xuICAgICAgU2lnbmFsPFJlYWRvbmx5QXJyYXk8UmVhZFQ+Pjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGJpbmRRdWVyeVRvU2lnbmFsKHRhcmdldDogU2lnbmFsPHVua25vd24+LCBxdWVyeUluZGV4OiBudW1iZXIpOiB2b2lkIHtcbiAgY29uc3Qgbm9kZSA9IHRhcmdldFtTSUdOQUxdIGFzIFF1ZXJ5U2lnbmFsTm9kZTx1bmtub3duPjtcbiAgbm9kZS5fbFZpZXcgPSBnZXRMVmlldygpO1xuICBub2RlLl9xdWVyeUluZGV4ID0gcXVlcnlJbmRleDtcbiAgbm9kZS5fcXVlcnlMaXN0ID0gbG9hZFF1ZXJ5SW50ZXJuYWwobm9kZS5fbFZpZXcsIHF1ZXJ5SW5kZXgpO1xuICBub2RlLl9xdWVyeUxpc3Qub25EaXJ0eSgoKSA9PiBub2RlLl9kaXJ0eUNvdW50ZXIudXBkYXRlKHYgPT4gdiArIDEpKTtcbn1cblxuZnVuY3Rpb24gcmVmcmVzaFNpZ25hbFF1ZXJ5PFY+KG5vZGU6IFF1ZXJ5U2lnbmFsTm9kZTxWPiwgZmlyc3RPbmx5OiBib29sZWFuKTogVnxSZWFkb25seUFycmF5PFY+IHtcbiAgY29uc3QgbFZpZXcgPSBub2RlLl9sVmlldztcbiAgY29uc3QgcXVlcnlJbmRleCA9IG5vZGUuX3F1ZXJ5SW5kZXg7XG5cbiAgLy8gVGhlcmUgYXJlIDIgY29uZGl0aW9ucyB1bmRlciB3aGljaCB3ZSB3YW50IHRvIHJldHVybiBcImVtcHR5XCIgcmVzdWx0cyBpbnN0ZWFkIG9mIHRoZSBvbmVzXG4gIC8vIGNvbGxlY3RlZCBieSBhIHF1ZXJ5OlxuICAvL1xuICAvLyAxKSBhIGdpdmVuIHF1ZXJ5IHdhc24ndCBjcmVhdGVkIHlldCAodGhpcyBpcyBhIHBlcmlvZCBvZiB0aW1lIGJldHdlZW4gdGhlIGRpcmVjdGl2ZSBjcmVhdGlvblxuICAvLyBhbmQgZXhlY3V0aW9uIG9mIHRoZSBxdWVyeSBjcmVhdGlvbiBmdW5jdGlvbikgLSBpbiB0aGlzIGNhc2UgYSBxdWVyeSBkb2Vzbid0IGV4aXN0IHlldCBhbmQgd2VcbiAgLy8gZG9uJ3QgaGF2ZSBhbnkgcmVzdWx0cyB0byByZXR1cm4uXG4gIC8vXG4gIC8vIDIpIHdlIGFyZSBpbiB0aGUgcHJvY2VzcyBvZiBjb25zdHJ1Y3RpbmcgYSB2aWV3ICh0aGUgZmlyc3RcbiAgLy8gY3JlYXRpb24gcGFzcyBkaWRuJ3QgZmluaXNoKSBhbmQgYSBxdWVyeSBtaWdodCBoYXZlIHBhcnRpYWwgcmVzdWx0cywgYnV0IHdlIGRvbid0IHdhbnQgdG9cbiAgLy8gcmV0dXJuIHRob3NlIC0gaW5zdGVhZCB3ZSBkbyBkZWxheSByZXN1bHRzIGNvbGxlY3Rpb24gdW50aWwgYWxsIG5vZGVzIGhhZCBhIGNoYW5jZSBvZiBtYXRjaGluZ1xuICAvLyBhbmQgd2UgY2FuIHByZXNlbnQgY29uc2lzdGVudCwgXCJhdG9taWNcIiAob24gYSB2aWV3IGxldmVsKSByZXN1bHRzLlxuICBpZiAobFZpZXcgPT09IHVuZGVmaW5lZCB8fCBxdWVyeUluZGV4ID09PSB1bmRlZmluZWQgfHwgKGxWaWV3W0ZMQUdTXSAmIExWaWV3RmxhZ3MuQ3JlYXRpb25Nb2RlKSkge1xuICAgIHJldHVybiAoZmlyc3RPbmx5ID8gdW5kZWZpbmVkIDogRU1QVFlfQVJSQVkpIGFzIFY7XG4gIH1cblxuICBjb25zdCBxdWVyeUxpc3QgPSBsb2FkUXVlcnlJbnRlcm5hbDxWPihsVmlldywgcXVlcnlJbmRleCk7XG4gIGNvbnN0IHRWaWV3ID0gbFZpZXdbVFZJRVddO1xuICBjb25zdCB0UXVlcnkgPSBnZXRUUXVlcnkodFZpZXcsIHF1ZXJ5SW5kZXgpO1xuXG4gIC8vIFRPRE8ocmVmYWN0b3IpOiBhZGQgYW4gdXRpbGl0eSBtZXRob2QgZm9yIHRoZSBmb2xsb3dpbmcgbG9naWNcbiAgY29uc3QgcmVzdWx0ID0gdFF1ZXJ5LmNyb3NzZXNOZ1RlbXBsYXRlID9cbiAgICAgIGNvbGxlY3RRdWVyeVJlc3VsdHM8Vj4odFZpZXcsIGxWaWV3LCBxdWVyeUluZGV4LCBbXSkgOlxuICAgICAgbWF0ZXJpYWxpemVWaWV3UmVzdWx0czxWPih0VmlldywgbFZpZXcsIHRRdWVyeSwgcXVlcnlJbmRleCk7XG5cbiAgcXVlcnlMaXN0LnJlc2V0KHJlc3VsdCwgdW53cmFwRWxlbWVudFJlZik7XG5cbiAgcmV0dXJuIGZpcnN0T25seSA/IHF1ZXJ5TGlzdC5maXJzdCA6IHF1ZXJ5TGlzdC50b0FycmF5KCk7XG59XG4iXX0=